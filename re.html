<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panchānga — Interactive Tithi Guide | Siddha Saraswatha</title>

  <link rel="shortcut icon" type="image/png" href="12.png">
  <!-- Global stylesheet -->
  <link rel="stylesheet" href="styles.css">
  <!-- Page stylesheet extracted earlier -->
  <link rel="stylesheet" href="panchanga.css">

  <!-- optional icons / bootstrap (you can keep or remove) -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">

  <!-- jQuery used only for fragment include loader -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"></script>

  <script>
    // load header/footer fragments (keeps progressive enhancement)
    $(function(){
      $("#header").load("header.html");
      $("#footer").load("footer.html");
    });
  </script>
</head>
<body>

  <div id="header" aria-hidden="false"></div>

  <main class="wrap" id="main" role="main">
    <header class="page-header">
      <h1>Panchānga — Interactive Tithi Guide</h1>
      <p class="muted">Click an activity to highlight recommended / caution / avoid tithis. Deep-link to any tithi using the anchor links.</p>
    </header>

    <nav style="text-align:center;margin-bottom:12px" aria-label="Quick links">
      <a class="activity-btn" href="#vara">Vara</a>
      <a class="activity-btn" href="#tithis">Tithis</a>
      <a class="activity-btn" href="#months">Months</a>
      <a class="activity-btn" href="#sixty">60-year cycle</a>
    </nav>

    <div class="controls" role="toolbar" aria-label="Choose activity">
      <button class="activity-btn" data-activity="all" aria-pressed="true">Show All</button>
      <button class="activity-btn" data-activity="wedding">Wedding</button>
      <button class="activity-btn" data-activity="housewarming">Housewarming</button>
      <button class="activity-btn" data-activity="travel">Travel</button>
    </div>

    <div class="legend" aria-hidden="false" style="margin-bottom:18px;">
      <div class="item"><span class="badge rec"></span> Recommended</div>
      <div class="item"><span class="badge caut"></span> Caution</div>
      <div class="item"><span class="badge avoid"></span> Avoid</div>
    </div>

    <!-- Tithis table -->
    <section id="tithis" class="card" style="padding:16px;">
      <h2>Tithis — quick interactive table</h2>
      <p class="muted small">Click an activity above to highlight which tithis are recommended, cautionary or to be avoided for that activity.</p>

      <table class="tithi-table" role="table" aria-label="Tithi recommendations">
        <thead>
          <tr>
            <th style="width:160px">Tithi</th>
            <th class="muted">Short description</th>
            <th style="width:120px">Wedding</th>
            <th style="width:160px">Housewarming</th>
            <th style="width:120px">Travel</th>
          </tr>
        </thead>
        <tbody id="tithiBody">
          <!-- rows populated by JS (tithis.json or fallback) -->
        </tbody>
      </table>
    </section>

    <section style="margin-top:18px">
      <p class="muted">Deep-link examples: <code>panchanga.html#tithi-pratipada</code> or <code>panchanga.html#tithi-purnima</code>.</p>

      <div style="text-align:center;margin-top:18px">
        <a class="activity-btn" href="services-page.html">Book a Muhurtha Consultation</a>
        <a class="activity-btn" href="learn.html" style="margin-left:8px">Learn Planets & Nakshatra</a>
      </div>
    </section>

    <!-- Muhurtha calculator -->
    <section id="muhurtha-calculator" style="margin-top:26px;">
      <div class="card" style="max-width:980px;margin:12px auto;">
        <h3 style="text-align:center;margin:0 0 8px">Muhurtha Calculator — Rāhu Kāla · Yāma Gaṇḍā · Durmuhurta · Varjya</h3>
        <p class="muted small" style="text-align:center;margin-bottom:10px">Auto-detects sunrise & sunset. Falls back to IP-based lookup when denied.</p>

        <div class="form-row">
          <label>
            Date
            <input id="calcDate" type="date">
          </label>

          <label>
            Sunrise
            <input id="sunrise" type="time" step="60">
          </label>

          <label>
            Sunset
            <input id="sunset" type="time" step="60">
          </label>

          <label>
            Region
            <select id="regionPreset" aria-label="Region preset">
              <option value="telugu" selected>Telugu (recommended)</option>
              <option value="default">Auto / Default</option>
              <option value="tamil">Tamil</option>
              <option value="kannada">Kannada</option>
              <option value="malayalam">Malayalam</option>
              <option value="hindi">Hindi / North India</option>
              <option value="custom">Custom</option>
            </select>
          </label>

          <button id="geoBtn" class="activity-btn" title="Attempt geolocation">Auto detect</button>
          <button id="calcBtn" class="activity-btn" style="background:var(--accent);color:#fff;border:none">Calculate</button>
          <button id="resetBtn" class="activity-btn">Reset</button>
        </div>

        <div id="calcResults" aria-live="polite" style="margin-top:12px;text-align:center" class="small muted">
          Loading... attempting auto-detect.
        </div>

        <details style="margin-top:12px">
          <summary class="small">Method notes</summary>
          <div style="margin-top:8px" class="small muted">
            Daytime is split into 8 equal parts. Rāhu Kāla and Yāma Gaṇḍā occupy whole 1/8th slots.
            Durmuhurta examples are shown as 48-minute blocks around sunrise by default.
            Sunrise/sunset source: <code>https://api.sunrise-sunset.org</code>. IP fallback uses <code>https://ipapi.co</code>.
          </div>
        </details>
      </div>
    </section>
  </main>

  <div id="footer" aria-hidden="false"></div>

  <!-- Script: functionality (tithis load, highlighting, muhurtha) -->
  <script>
  (function () {
    'use strict';

    /* ------------------ Helpers ------------------ */
    function parseTimeToMinutes(t) {
      if (!t) return null;
      const [hh, mm] = t.split(':').map(Number);
      return hh * 60 + (mm || 0);
    }
    function minutesToHHMM(m) {
      m = Math.round(m);
      m = (m + 24 * 60) % (24 * 60);
      const hh = String(Math.floor(m / 60)).padStart(2, '0');
      const mm = String(m % 60).padStart(2, '0');
      return hh + ':' + mm;
    }
    function toLocalHHMMFromISO(iso) {
      const d = new Date(iso);
      return d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', hour12: false });
    }

    /* ------------------ Tithis (load JSON or fallback) ------------------ */
    const tithisUrl = 'tithis.json';
    const fallbackTithis = [
      {"id":"tithi-pratipada","name":"Pratipada","desc":"Auspicious for beginnings and ceremonies.","wedding":"rec","housewarming":"rec","travel":"rec"},
      {"id":"tithi-dwitiya","name":"Dwitiya","desc":"Good for laying foundations and starting work.","wedding":"rec","housewarming":"rec","travel":"caut"},
      {"id":"tithi-tritiya","name":"Tritiya","desc":"Victory & auspicious starts.","wedding":"rec","housewarming":"caut","travel":"rec"},
      {"id":"tithi-chaturthi","name":"Chaturthi","desc":"Often Rikta — avoid major new beginnings.","wedding":"avoid","housewarming":"avoid","travel":"caut"},
      {"id":"tithi-panchami","name":"Panchami","desc":"Favourable for healing; completing tasks.","wedding":"caut","housewarming":"rec","travel":"rec"},
      {"id":"tithi-shasthi","name":"Shasthi","desc":"Good for construction and coronation; not ideal for marriage.","wedding":"avoid","housewarming":"rec","travel":"caut"},
      {"id":"tithi-saptami","name":"Saptami","desc":"Good for journeys and transport-related starts.","wedding":"rec","housewarming":"caut","travel":"rec"},
      {"id":"tithi-ashtami","name":"Ashtami","desc":"Often good for competitive/martial activities and sports.","wedding":"caut","housewarming":"avoid","travel":"rec"},
      {"id":"tithi-navami","name":"Navami","desc":"Rikta; generally not for auspicious starts.","wedding":"avoid","housewarming":"avoid","travel":"caut"},
      {"id":"tithi-dasami","name":"Dasami","desc":"Good for completion and virtuous acts.","wedding":"rec","housewarming":"rec","travel":"rec"},
      {"id":"tithi-ekadasi","name":"Ekadasi","desc":"Fasting, worship, vows — spiritual focus.","wedding":"caut","housewarming":"caut","travel":"avoid"},
      {"id":"tithi-dwadasi","name":"Dwadasi","desc":"Auspicious for certain rituals and duties.","wedding":"rec","housewarming":"rec","travel":"caut"},
      {"id":"tithi-trayodasi","name":"Trayodasi","desc":"Pradosha — auspicious for Shiva worship and many ceremonies.","wedding":"rec","housewarming":"caut","travel":"rec"},
      {"id":"tithi-chaturdasi","name":"Chaturdasi","desc":"Rikta — not ideal for major beginnings.","wedding":"avoid","housewarming":"avoid","travel":"caut"},
      {"id":"tithi-purnima","name":"Purnima (Full Moon)","desc":"Usually auspicious for many ceremonies and completions.","wedding":"rec","housewarming":"rec","travel":"rec"},
      {"id":"tithi-amavasya","name":"Amavasya (New Moon)","desc":"Often reserved for ancestral rites; treat case-by-case.","wedding":"avoid","housewarming":"caut","travel":"caut"}
    ];

    async function loadTithis() {
      try {
        const res = await fetch(tithisUrl, { cache: 'no-cache' });
        if (!res.ok) throw new Error('fetch failed');
        const arr = await res.json();
        if (!Array.isArray(arr) || arr.length === 0) throw new Error('bad json');
        return arr;
      } catch (e) {
        console.warn('Loading tithis.json failed — using fallback.', e);
        return fallbackTithis;
      }
    }

    function statusText(s) { return s === 'rec' ? 'Recommended' : (s === 'caut' ? 'Caution' : 'Avoid'); }

    function renderTithiTable(tithiData) {
      const tithiBody = document.getElementById('tithiBody');
      tithiBody.innerHTML = '';
      tithiData.forEach(t => {
        const tr = document.createElement('tr');
        tr.id = t.id;
        tr.dataset.tithi = (t.name || '').toLowerCase();
        tr.innerHTML = `
          <td><a class="anchor-link" href="#${t.id}">${t.name}</a></td>
          <td class="muted">${t.desc || ''}</td>
          <td data-wedding="${t.wedding || 'caut'}">${statusText(t.wedding)}</td>
          <td data-housewarming="${t.housewarming || 'caut'}">${statusText(t.housewarming)}</td>
          <td data-travel="${t.travel || 'caut'}">${statusText(t.travel)}</td>
        `;
        tithiBody.appendChild(tr);
      });
    }

    /* ------------------ Activity highlighting ------------------ */
    const statusClass = { rec: 'highlight-recommended', caut: 'highlight-caution', avoid: 'highlight-avoid' };

    function setActiveButton(btn) {
      document.querySelectorAll('.controls .activity-btn').forEach(b => b.classList.remove('active'));
      if (btn) btn.classList.add('active');
    }

    function highlightFor(activity) {
      document.querySelectorAll('#tithiBody tr').forEach(tr => tr.classList.remove(...Object.values(statusClass)));
      if (!activity || activity === 'all') return;
      document.querySelectorAll('#tithiBody tr').forEach(tr => {
        const cell = tr.querySelector('[data-' + activity + ']');
        if (!cell) return;
        const stat = cell.getAttribute('data-' + activity);
        if (stat && statusClass[stat]) tr.classList.add(statusClass[stat]);
      });
    }

    document.querySelectorAll('.controls .activity-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const activity = btn.dataset.activity || 'all';
        setActiveButton(btn);
        highlightFor(activity);
        document.querySelectorAll('.controls .activity-btn').forEach(b => b.setAttribute('aria-pressed', 'false'));
        btn.setAttribute('aria-pressed', 'true');
      });
    });

    /* ------------------ Deep-link support ------------------ */
    function openAndScrollToHash() {
      const id = location.hash && location.hash.slice(1);
      if (!id) return;
      const el = document.getElementById(id);
      if (!el) return;
      const detailsParent = el.closest('details');
      if (detailsParent) detailsParent.open = true;
      el.classList.add('deep-target');
      setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block: 'center' }), 80);
      setTimeout(() => el.classList.remove('deep-target'), 2600);
    }
    window.addEventListener('load', openAndScrollToHash);
    window.addEventListener('hashchange', openAndScrollToHash);

    /* ------------------ Muhurtha calculator ------------------ */
    const MUHURTA = 48;
    const HALF_MUHURTA = 24;

    // Telugu mapping tuned here (Sun->Sat slots). Adjust if you want a different tradition.
    const presetMappings = {
      default: { rahu: [8,2,7,5,6,4,3], yama: [7,5,6,4,3,2,1], durIndices: [-1,0,1] },
      telugu:  { rahu: [8,2,7,5,6,4,3], yama: [7,5,6,4,3,2,1], durIndices: [-1,0,1] },
      tamil:   { rahu: [8,2,7,5,6,4,3], yama: [7,5,6,4,3,2,1], durIndices: [-1,0,1] },
      kannada: { rahu: [8,2,7,5,6,4,3], yama: [7,5,6,4,3,2,1], durIndices: [-1,0,1] },
      malayalam:{ rahu:[8,2,7,5,6,4,3], yama:[7,5,6,4,3,2,1], durIndices:[-1,0,1] },
      hindi:   { rahu: [8,2,7,5,6,4,3], yama: [7,5,6,4,3,2,1], durIndices: [-2,-1,0] }
    };

    function computeSlotTimes(sunriseMin, sunsetMin, slotIndex) {
      const dayDuration = sunsetMin - sunriseMin;
      const slot = dayDuration / 8;
      const start = sunriseMin + slot * (slotIndex - 1);
      const end = start + slot;
      return { start, end };
    }

    // DOM refs
    const geoBtn = document.getElementById('geoBtn');
    const calcBtn = document.getElementById('calcBtn');
    const resetBtn = document.getElementById('resetBtn');
    const dateInput = document.getElementById('calcDate');
    const sunriseInput = document.getElementById('sunrise');
    const sunsetInput = document.getElementById('sunset');
    const regionSel = document.getElementById('regionPreset');
    const resultsEl = document.getElementById('calcResults');

    if (dateInput) dateInput.value = new Date().toISOString().slice(0, 10);

    async function fetchSunriseSunsetByCoords(lat, lng, date) {
      try {
        const url = `https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lng}&date=${date}&formatted=0`;
        const r = await fetch(url);
        const j = await r.json();
        if (!j || j.status !== 'OK') throw new Error('sunrise-sunset API error');
        return { sunrise: toLocalHHMMFromISO(j.results.sunrise), sunset: toLocalHHMMFromISO(j.results.sunset) };
      } catch (err) {
        console.warn('Sunrise API failed:', err);
        return null;
      }
    }

    async function tryAutoDetectAndFill(autoRun = true) {
      resultsEl.textContent = 'Attempting to auto-detect location & sunrise/sunset…';
      const date = dateInput.value || new Date().toISOString().slice(0, 10);

      // 1) Browser geolocation
      if (navigator.geolocation) {
        try {
          const pos = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
          });
          const got = await fetchSunriseSunsetByCoords(pos.coords.latitude, pos.coords.longitude, date);
          if (got) {
            sunriseInput.value = got.sunrise;
            sunsetInput.value = got.sunset;
            resultsEl.textContent = `Auto-filled sunrise ${got.sunrise} & sunset ${got.sunset} (device location).`;
            if (autoRun) computeAndRender();
            return;
          }
        } catch (err) {
          console.warn('Geolocation failed or denied:', err);
        }
      }

      // 2) IP fallback
      try {
        resultsEl.textContent = 'Geolocation denied — using IP-based fallback (approximate).';
        const resp = await fetch('https://ipapi.co/json/');
        const data = await resp.json();
        if (!data || !data.latitude || !data.longitude) throw new Error('ipapi did not return coords');
        const got = await fetchSunriseSunsetByCoords(data.latitude, data.longitude, date);
        if (got) {
          sunriseInput.value = got.sunrise;
          sunsetInput.value = got.sunset;
          resultsEl.textContent = `Auto-filled sunrise ${got.sunrise} & sunset ${got.sunset} (approx: ${data.city || data.region || data.country_name}).`;
          if (autoRun) computeAndRender();
          return;
        } else {
          resultsEl.textContent = 'Failed to fetch sunrise/sunset via IP fallback — please enter times manually.';
        }
      } catch (err) {
        console.warn('IP fallback failed:', err);
        resultsEl.textContent = 'Auto-detect failed — please enter sunrise & sunset manually and click Calculate.';
      }
    }

    if (geoBtn) geoBtn.addEventListener('click', () => tryAutoDetectAndFill(true));
    if (resetBtn) resetBtn.addEventListener('click', () => {
      if (dateInput) dateInput.value = new Date().toISOString().slice(0, 10);
      if (sunriseInput) sunriseInput.value = '';
      if (sunsetInput) sunsetInput.value = '';
      if (regionSel) regionSel.value = 'telugu';
      resultsEl.textContent = 'Reset. Use Auto detect or enter times manually then click Calculate.';
    });

    function computeAndRender() {
      resultsEl.innerHTML = '';
      const sunriseVal = sunriseInput.value;
      const sunsetVal = sunsetInput.value;
      const dateVal = dateInput.value || new Date().toISOString().slice(0, 10);

      if (!sunriseVal || !sunsetVal) {
        resultsEl.textContent = 'Please provide sunrise and sunset times (or use Auto detect) and click Calculate.';
        return;
      }

      const sunriseMin = parseTimeToMinutes(sunriseVal);
      const sunsetMin = parseTimeToMinutes(sunsetVal);
      if (sunsetMin <= sunriseMin) {
        resultsEl.textContent = 'Sunset must be later than sunrise. Adjust times.';
        return;
      }

      let mapping = presetMappings[regionSel.value] || presetMappings.default;

      const wd = new Date(dateVal + 'T00:00').getDay(); // 0=Sun ... 6=Sat
      const rahuSlot = mapping.rahu[wd];
      const yamaSlot = mapping.yama[wd];

      const rSlot = computeSlotTimes(sunriseMin, sunsetMin, rahuSlot);
      const ySlot = computeSlotTimes(sunriseMin, sunsetMin, yamaSlot);

      // generate muhurta windows for durIndices relative to sunrise
      const baseStart = sunriseMin - 8 * MUHURTA;
      const muList = [];
      for (let i = 0; i < 40; i++) {
        const s = baseStart + i * MUHURTA;
        muList.push({ idx: i - 8, start: s, end: s + MUHURTA });
      }
      const durBlocks = muList.filter(w => mapping.durIndices.includes(w.idx)).map(w => ({ start: w.start, end: w.end }));

      const varBefore = { start: sunriseMin - HALF_MUHURTA, end: sunriseMin };
      const varAfter = { start: sunsetMin, end: sunsetMin + HALF_MUHURTA };

      const weekdayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const tzName = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Local';
      const offsetMin = -new Date().getTimezoneOffset(); // minutes east of UTC
      const sign = offsetMin >= 0 ? '+' : '-';
      const abs = Math.abs(offsetMin);
      const hh = String(Math.floor(abs / 60)).padStart(2, '0');
      const mm = String(abs % 60).padStart(2, '0');
      const utcLabel = `UTC${sign}${hh}:${mm}`;

      const out = document.createElement('div');
      out.innerHTML = `
        <h4 style="margin:8px 0">Results — ${dateVal} — ${weekdayNames[wd]} <span class="tz-label">(${utcLabel} — ${tzName})</span></h4>
        <table style="width:100%;border-collapse:collapse">
          <tr><td style="width:170px"><strong>Sunrise</strong></td><td>${sunriseVal}</td></tr>
          <tr><td><strong>Sunset</strong></td><td>${sunsetVal}</td></tr>
          <tr><td><strong>Daytime (mins)</strong></td><td>${sunsetMin - sunriseMin} minutes</td></tr>
          <tr><td><strong>1/8th slot</strong></td><td>${((sunsetMin - sunriseMin) / 8).toFixed(1)} minutes</td></tr>
        </table>
        <hr style="margin:10px 0">
        <h5>Rāhu Kāla</h5><p class="small">Slot #${rahuSlot}: <strong>${minutesToHHMM(rSlot.start)} — ${minutesToHHMM(rSlot.end)}</strong></p>
        <h5>Yāma Gaṇḍā</h5><p class="small">Slot #${yamaSlot}: <strong>${minutesToHHMM(ySlot.start)} — ${minutesToHHMM(ySlot.end)}</strong></p>
        <h5>Durmuhurta (example 48-min windows)</h5>
        <ul class="small">${durBlocks.map(b => `<li>${minutesToHHMM(b.start)} — ${minutesToHHMM(b.end)}</li>`).join('')}</ul>
        <h5>Varjyam (examples)</h5>
        <ul class="small">
          <li>Before sunrise: ${minutesToHHMM(varBefore.start)} — ${minutesToHHMM(varBefore.end)}</li>
          <li>After sunset: ${minutesToHHMM(varAfter.start)} — ${minutesToHHMM(varAfter.end)}</li>
        </ul>
        <p class="small muted">Preset: <strong>${regionSel.value}</strong></p>
        <p style="margin-top:8px">
          <button id="copyResults" class="activity-btn">Copy results</button>
          <a class="activity-btn" href="services-page.html" style="background:var(--accent);color:#fff;border:none;margin-left:8px">Book Muhurtha</a>
        </p>
      `;
      resultsEl.appendChild(out);

      document.getElementById('copyResults')?.addEventListener('click', () => {
        const txt = `Date: ${dateVal}
Timezone: ${utcLabel} — ${tzName}
Sunrise: ${sunriseVal}
Sunset: ${sunsetVal}
Rahu Kala (slot ${rahuSlot}): ${minutesToHHMM(rSlot.start)} - ${minutesToHHMM(rSlot.end)}
Yama Ganda (slot ${yamaSlot}): ${minutesToHHMM(ySlot.start)} - ${minutesToHHMM(ySlot.end)}
Durmuhurta examples: ${durBlocks.map(b => minutesToHHMM(b.start) + '-' + minutesToHHMM(b.end)).join(', ')}
Varjyam examples: ${minutesToHHMM(varBefore.start)}-${minutesToHHMM(varBefore.end)}, ${minutesToHHMM(varAfter.start)}-${minutesToHHMM(varAfter.end)}
(Preset: ${regionSel.value})`;
        navigator.clipboard?.writeText(txt).then(() => alert('Copied results')).catch(() => prompt('Copy results', txt));
      });
    }

    if (calcBtn) calcBtn.addEventListener('click', computeAndRender);

    /* ------------------ Startup ------------------ */
    // Load tithis then try autostart detection
    (async function init() {
      const t = await loadTithis();
      renderTithiTable(t);
      // default active button
      const defaultBtn = document.querySelector('.controls .activity-btn[data-activity="all"]');
      setActiveButton(defaultBtn);
      // auto-detect sunrise/sunset and compute once on load
      tryAutoDetectAndFill(true);
    })();

  })();
  </script>
</body>
</html>
