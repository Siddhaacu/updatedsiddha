<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panchānga — Interactive Tithi Guide | Siddha Saraswatha</title>

  <link rel="shortcut icon" type="image/png" href="12.png">
  <link rel="stylesheet" href="styles.css">

  <style>
    :root{ --accent:#c06b00; --muted:#6b6b6b; --max-w:1100px }

    .wrap{max-width:var(--max-w);margin:18px auto;padding:0 18px}
    .page-header{text-align:center;margin-bottom:12px}
    .muted{color:var(--muted)}
    .card{background:#fff;padding:14px;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.04)}

    .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:12px 0}
    .activity-btn{padding:8px 12px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);cursor:pointer;background:#fff;font-weight:600}
    .activity-btn.active{box-shadow:0 6px 18px rgba(192,107,0,0.12);background:linear-gradient(90deg,#ffd37b,#ffb84d);color:#221403;border-color:transparent}
    .legend{display:flex;gap:10px;justify-content:center;margin-top:8px}
    .legend .item{display:flex;gap:8px;align-items:center;font-size:.95rem}
    .badge{width:12px;height:12px;border-radius:3px;display:inline-block}
    .rec{background:#DFF5E0;border:1px solid #B6E6B4}
    .caut{background:#FFF3D9;border:1px solid #FFD59A}
    .avoid{background:#FDE7E7;border:1px solid #F5B5B5}

    .tithi-table{width:100%;border-collapse:collapse;margin-top:12px}
    .tithi-table th,.tithi-table td{padding:10px 12px;border-bottom:1px solid rgba(0,0,0,0.04);text-align:left;vertical-align:middle}
    .tithi-table tr.highlight-recommended{background:rgba(35,177,85,0.06)}
    .tithi-table tr.highlight-caution{background:rgba(255,184,77,0.06)}
    .tithi-table tr.highlight-avoid{background:rgba(220,60,60,0.04)}
    .anchor-link{font-weight:700;color:var(--accent);text-decoration:none}
    .small{font-size:.92rem}
    .controls .activity-btn { min-width:120px; text-align:center; }

    @media(max-width:720px){
      .controls{flex-direction:column;align-items:center}
      .tithi-table th:nth-child(2), .tithi-table td:nth-child(2) { display:none }
    }

    .deep-target { box-shadow:0 6px 28px rgba(192,107,0,0.14); border-radius:8px; padding:8px; }
    .tz-label{font-weight:700;color:#444;margin-left:8px}
  </style>
</head>

<body>
  <div include-html="header.html"></div>

  <main class="wrap" id="main" role="main">
    <header class="page-header">
      <h1>Panchānga — Interactive Tithi Guide</h1>
      <p class="muted">Click an activity to highlight recommended / caution / avoid tithis. Deep-link to any tithi using the anchor links.</p>
    </header>

    <nav style="text-align:center;margin-bottom:12px" aria-label="Quick links">
      <a class="activity-btn" href="#vara">Vara</a>
      <a class="activity-btn" href="#tithis">Tithis</a>
      <a class="activity-btn" href="#months">Months</a>
      <a class="activity-btn" href="#sixty">60-year cycle</a>
    </nav>

    <div class="controls" role="toolbar" aria-label="Choose activity">
      <button class="activity-btn" data-activity="all" aria-pressed="true">Show All</button>
      <button class="activity-btn" data-activity="wedding">Wedding</button>
      <button class="activity-btn" data-activity="housewarming">Housewarming</button>
      <button class="activity-btn" data-activity="travel">Travel</button>
    </div>

    <div class="legend" aria-hidden="false" style="margin-bottom:18px;">
      <div class="item"><span class="badge rec"></span> Recommended</div>
      <div class="item"><span class="badge caut"></span> Caution</div>
      <div class="item"><span class="badge avoid"></span> Avoid</div>
    </div>

    <section id="tithis" class="card" style="padding:16px;">
      <h2>Tithis — quick interactive table</h2>
      <p class="muted small">Click an activity above to highlight which tithis are recommended, cautionary or to be avoided for that activity.</p>

      <table class="tithi-table" role="table" aria-label="Tithi recommendations">
        <thead>
          <tr>
            <th style="width:160px">Tithi</th>
            <th class="muted">Short description</th>
            <th style="width:120px">Wedding</th>
            <th style="width:160px">Housewarming</th>
            <th style="width:120px">Travel</th>
          </tr>
        </thead>
        <tbody id="tithiBody">
          <!-- JS loads rows from tithis.json -->
        </tbody>
      </table>
    </section>

    <section style="margin-top:18px">
      <p class="muted">Deep-link examples: <code>panchanga.html#tithi-pratipada</code> or <code>panchanga.html#tithi-purnima</code>.</p>

      <div style="text-align:center;margin-top:18px">
        <a class="activity-btn" href="services-page.html">Book a Muhurtha Consultation</a>
        <a class="activity-btn" href="learn.html" style="margin-left:8px">Learn Planets & Nakshatra</a>
      </div>
    </section>

    <section id="muhurtha-calculator" style="margin-top:26px;">
      <div class="card" style="max-width:980px;margin:12px auto;">
        <h3 style="text-align:center;margin:0 0 8px">Muhurtha Calculator — Rāhu Kāla · Yāma Gaṇḍā · Durmuhurta · Varjya</h3>
        <p class="muted small" style="text-align:center;margin-bottom:10px">Auto-detects sunrise & sunset. Falls back to IP-based lookup when denied.</p>

        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:end;justify-content:center">
          <label style="display:flex;flex-direction:column;gap:6px;">
            Date
            <input id="calcDate" type="date">
          </label>

          <label style="display:flex;flex-direction:column;gap:6px;">
            Sunrise
            <input id="sunrise" type="time">
          </label>

          <label style="display:flex;flex-direction:column;gap:6px;">
            Sunset
            <input id="sunset" type="time">
          </label>

          <label style="display:flex;flex-direction:column;gap:6px;">
            Region
            <select id="regionPreset" aria-label="Region preset">
              <option value="default">Auto / Default</option>
              <option value="telugu">Telugu</option>
              <option value="tamil">Tamil</option>
              <option value="kannada">Kannada</option>
              <option value="malayalam">Malayalam</option>
              <option value="hindi">Hindi / North India</option>
              <option value="custom">Custom</option>
            </select>
          </label>

          <button id="geoBtn" class="activity-btn" title="Attempt geolocation">Auto detect</button>
          <button id="calcBtn" class="activity-btn" style="background:var(--accent);color:#fff;border:none">Calculate</button>
          <button id="resetBtn" class="activity-btn">Reset</button>
        </div>

        <div id="calcResults" aria-live="polite" style="margin-top:12px;text-align:center" class="small muted">
          Loading... attempting auto-detect.
        </div>

        <details style="margin-top:12px">
          <summary class="small">Method notes</summary>
          <div style="margin-top:8px" class="small muted">
            Daytime split into 8 equal parts. Rāhu/Kala and Yāma occupy whole 1/8th slots. Durmuhurta windows are shown as 48-minute blocks around sunrise by default. Sunrise/sunset from <code>api.sunrise-sunset.org</code>. IP fallback uses <code>ipapi.co</code>.
          </div>
        </details>
      </div>
    </section>
  </main>

  <div include-html="footer.html"></div>

  <script>
  (function(){
    /* Utility */
    function parseTimeToMinutes(t){ if(!t) return null; const [hh,mm]=t.split(':').map(Number); return hh*60+mm; }
    function minutesToHHMM(m){ m=Math.round(m); m=(m+24*60)%(24*60); const hh=String(Math.floor(m/60)).padStart(2,'0'); const mm=String(m%60).padStart(2,'0'); return hh+':'+mm; }
    function toLocalHHMMFromISO(iso){ const d=new Date(iso); return d.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit',hour12:false}); }
    function formatUTCOffset(offsetMin){
      // offsetMin = minutes east of UTC is negative of getTimezoneOffset
      const sign = offsetMin >= 0 ? '+' : '-';
      const absMin = Math.abs(offsetMin);
      const hh = String(Math.floor(absMin/60)).padStart(2,'0');
      const mm = String(absMin%60).padStart(2,'0');
      return `UTC${sign}${hh}:${mm}`;
    }

    /* Tithis — load from external JSON (tithis.json). If fetch fails, fallback to embedded array. */
    const tithisUrl = 'tithis.json';
    const fallbackTithis = [
      {"id":"tithi-pratipada","name":"Pratipada","desc":"Auspicious for beginnings and ceremonies.","wedding":"rec","housewarming":"rec","travel":"rec"},
      {"id":"tithi-dwitiya","name":"Dwitiya","desc":"Good for laying foundations and starting work.","wedding":"rec","housewarming":"rec","travel":"caut"},
      {"id":"tithi-tritiya","name":"Tritiya","desc":"Victory & auspicious starts.","wedding":"rec","housewarming":"caut","travel":"rec"},
      {"id":"tithi-chaturthi","name":"Chaturthi","desc":"Often Rikta — avoid major new beginnings.","wedding":"avoid","housewarming":"avoid","travel":"caut"},
      {"id":"tithi-panchami","name":"Panchami","desc":"Favourable for healing; completing tasks.","wedding":"caut","housewarming":"rec","travel":"rec"},
      {"id":"tithi-shasthi","name":"Shasthi","desc":"Good for construction and coronation; not ideal for marriage.","wedding":"avoid","housewarming":"rec","travel":"caut"},
      {"id":"tithi-saptami","name":"Saptami","desc":"Good for journeys and transport-related starts.","wedding":"rec","housewarming":"caut","travel":"rec"},
      {"id":"tithi-ashtami","name":"Ashtami","desc":"Often good for competitive/martial activities and sports.","wedding":"caut","housewarming":"avoid","travel":"rec"},
      {"id":"tithi-navami","name":"Navami","desc":"Rikta; generally not for auspicious starts.","wedding":"avoid","housewarming":"avoid","travel":"caut"},
      {"id":"tithi-dasami","name":"Dasami","desc":"Good for completion and virtuous acts.","wedding":"rec","housewarming":"rec","travel":"rec"},
      {"id":"tithi-ekadasi","name":"Ekadasi","desc":"Fasting, worship, vows — spiritual focus.","wedding":"caut","housewarming":"caut","travel":"avoid"},
      {"id":"tithi-dwadasi","name":"Dwadasi","desc":"Auspicious for certain rituals and duties.","wedding":"rec","housewarming":"rec","travel":"caut"},
      {"id":"tithi-trayodasi","name":"Trayodasi","desc":"Pradosha — auspicious for Shiva worship and many ceremonies.","wedding":"rec","housewarming":"caut","travel":"rec"},
      {"id":"tithi-chaturdasi","name":"Chaturdasi","desc":"Rikta — not ideal for major beginnings.","wedding":"avoid","housewarming":"avoid","travel":"caut"},
      {"id":"tithi-purnima","name":"Purnima (Full Moon)","desc":"Usually auspicious for many ceremonies and completions.","wedding":"rec","housewarming":"rec","travel":"rec"},
      {"id":"tithi-amavasya","name":"Amavasya (New Moon)","desc":"Often reserved for ancestral rites; treat case-by-case.","wedding":"avoid","housewarming":"caut","travel":"caut"}
    ];

    async function loadTithis(){
      try{
        const res = await fetch(tithisUrl, {cache:'no-cache'});
        if (!res.ok) throw new Error('fetch failed');
        const arr = await res.json();
        if (!Array.isArray(arr) || arr.length === 0) throw new Error('bad json');
        return arr;
      }catch(e){
        console.warn('Loading tithis.json failed — using fallback.', e);
        return fallbackTithis;
      }
    }

    function renderTithiTable(tithiData){
      const tithiBody = document.getElementById('tithiBody');
      tithiBody.innerHTML = '';
      tithiData.forEach(t => {
        const tr = document.createElement('tr');
        tr.id = t.id;
        tr.dataset.tithi = t.name.toLowerCase();
        tr.innerHTML = `
          <td><a class="anchor-link" href="#${t.id}">${t.name}</a></td>
          <td class="muted">${t.desc}</td>
          <td data-wedding="${t.wedding}">${statusText(t.wedding)}</td>
          <td data-housewarming="${t.housewarming}">${statusText(t.housewarming)}</td>
          <td data-travel="${t.travel}">${statusText(t.travel)}</td>
        `;
        tithiBody.appendChild(tr);
      });
    }
    function statusText(s){ return s === 'rec' ? 'Recommended' : (s === 'caut' ? 'Caution' : 'Avoid'); }

    /* Load & render tithis on startup */
    loadTithis().then(arr => renderTithiTable(arr));

    /* Activity highlight behavior */
    const statusClass = { rec: 'highlight-recommended', caut: 'highlight-caution', avoid: 'highlight-avoid' };
    function setActiveButton(btn) {
      document.querySelectorAll('.controls .activity-btn').forEach(b => b.classList.remove('active'));
      if (btn) btn.classList.add('active');
    }
    function highlightFor(activity) {
      document.querySelectorAll('#tithiBody tr').forEach(tr => tr.classList.remove(...Object.values(statusClass)));
      if (!activity || activity === 'all') return;
      document.querySelectorAll('#tithiBody tr').forEach(tr => {
        const cell = tr.querySelector('[data-' + activity + ']');
        if (!cell) return;
        const stat = cell.getAttribute('data-' + activity);
        if (stat && statusClass[stat]) tr.classList.add(statusClass[stat]);
      });
    }
    document.querySelectorAll('.controls .activity-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const activity = btn.dataset.activity || 'all';
        setActiveButton(btn);
        highlightFor(activity);
        document.querySelectorAll('.controls .activity-btn').forEach(b => b.setAttribute('aria-pressed','false'));
        btn.setAttribute('aria-pressed','true');
      });
    });
    const defaultBtn = document.querySelector('.controls .activity-btn[data-activity="all"]');
    if (defaultBtn) setActiveButton(defaultBtn);

    /* Deep-link support */
    function openAndScrollToHash() {
      const id = location.hash && location.hash.slice(1);
      if (!id) return;
      const el = document.getElementById(id);
      if (!el) return;
      const detailsParent = el.closest('details');
      if (detailsParent) detailsParent.open = true;
      el.classList.add('deep-target');
      setTimeout(()=>el.scrollIntoView({behavior:'smooth', block:'center'}), 80);
      setTimeout(()=> el.classList.remove('deep-target'), 2600);
    }
    window.addEventListener('load', openAndScrollToHash);
    window.addEventListener('hashchange', openAndScrollToHash);

    /* Muhurtha calculator */
    const MUHURTA = 48;
    const HALF_MUHURTA = 24;

    // PRESET MAPPINGS
    // Telugu mapping tuned here explicitly (common south-Indian mapping).
    // RAHU array and YAMA array map Sun->Sat (7 numbers). Values are slot numbers 1..8.
    const presetMappings = {
      default: { rahu: [8,2,7,5,6,4,3], yama: [7,5,6,4,3,2,1], durIndices: [-1,0,1] },
      telugu:  { rahu: [8,2,7,5,6,4,3], yama: [7,5,6,4,3,2,1], durIndices: [-1,0,1] }, // tuned for Telugu tradition
      tamil:   { rahu: [8,2,7,5,6,4,3], yama: [7,5,6,4,3,2,1], durIndices: [-1,0,1] },
      kannada: { rahu: [8,2,7,5,6,4,3], yama: [7,5,6,4,3,2,1], durIndices: [-1,0,1] },
      malayalam:{ rahu:[8,2,7,5,6,4,3], yama:[7,5,6,4,3,2,1], durIndices:[-1,0,1] },
      hindi:   { rahu: [8,2,7,5,6,4,3], yama: [7,5,6,4,3,2,1], durIndices: [-2,-1,0] }
    };

    function computeSlotTimes(sunriseMin, sunsetMin, slotIndex){
      const dayDuration = sunsetMin - sunriseMin;
      const slot = dayDuration / 8;
      const start = sunriseMin + slot * (slotIndex - 1);
      const end = start + slot;
      return { start, end };
    }

    // DOM refs
    const geoBtn = document.getElementById('geoBtn');
    const calcBtn = document.getElementById('calcBtn');
    const resetBtn = document.getElementById('resetBtn');
    const dateInput = document.getElementById('calcDate');
    const sunriseInput = document.getElementById('sunrise');
    const sunsetInput = document.getElementById('sunset');
    const regionSel = document.getElementById('regionPreset');
    const resultsEl = document.getElementById('calcResults');

    if(dateInput) dateInput.value = new Date().toISOString().slice(0,10);

    async function fetchSunriseSunsetByCoords(lat,lng,date){
      try{
        const url = `https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lng}&date=${date}&formatted=0`;
        const r = await fetch(url);
        const j = await r.json();
        if (!j || j.status!=='OK') throw new Error('sunrise-sunset API error');
        return { sunrise: toLocalHHMMFromISO(j.results.sunrise), sunset: toLocalHHMMFromISO(j.results.sunset) };
      }catch(e){ console.warn(e); return null; }
    }

    async function tryAutoDetectAndFill(autoRun=true){
      resultsEl.textContent = 'Attempting to auto-detect location & sunrise/sunset…';
      const date = dateInput.value || new Date().toISOString().slice(0,10);

      if (navigator.geolocation){
        try{
          const pos = await new Promise((res,rej)=> navigator.geolocation.getCurrentPosition(res,rej,{timeout:10000}));
          const got = await fetchSunriseSunsetByCoords(pos.coords.latitude, pos.coords.longitude, date);
          if (got){ sunriseInput.value = got.sunrise; sunsetInput.value = got.sunset; resultsEl.textContent = `Auto-filled sunrise ${got.sunrise} & sunset ${got.sunset} (your device).`; if (autoRun) computeAndRender(); return; }
        }catch(err){ console.warn('geolocation failed', err); }
      }

      try{
        resultsEl.textContent = 'Geolocation denied — using IP fallback (approximate).';
        const resp = await fetch('https://ipapi.co/json/');
        const data = await resp.json();
        if (!data || !data.latitude) throw new Error('ipapi failed');
        const got = await fetchSunriseSunsetByCoords(data.latitude, data.longitude, date);
        if (got){ sunriseInput.value = got.sunrise; sunsetInput.value = got.sunset; resultsEl.textContent = `Auto-filled sunrise ${got.sunrise} & sunset ${got.sunset} (approx: ${data.city||data.region||data.country_name}).`; if (autoRun) computeAndRender(); return; }
      }catch(err){ console.warn('ip fallback failed', err); resultsEl.textContent = 'Auto-detect failed — enter sunrise & sunset manually and click Calculate.'; }
    }

    if (geoBtn) geoBtn.addEventListener('click', () => tryAutoDetectAndFill(true));
    if (resetBtn) resetBtn.addEventListener('click', () => {
      if(dateInput) dateInput.value = new Date().toISOString().slice(0,10);
      if(sunriseInput) sunriseInput.value = '';
      if(sunsetInput) sunsetInput.value = '';
      if(regionSel) regionSel.value = 'default';
      resultsEl.textContent = 'Reset. Use Auto detect or enter times manually then click Calculate.';
    });

    function computeAndRender(){
      resultsEl.innerHTML = '';
      const sunriseVal = sunriseInput.value;
      const sunsetVal = sunsetInput.value;
      const dateVal = dateInput.value || new Date().toISOString().slice(0,10);
      if(!sunriseVal || !sunsetVal){ resultsEl.textContent = 'Please provide sunrise and sunset times (or use Auto detect) and click Calculate.'; return; }
      const sunriseMin = parseTimeToMinutes(sunriseVal);
      const sunsetMin = parseTimeToMinutes(sunsetVal);
      if (sunsetMin <= sunriseMin){ resultsEl.textContent = 'Sunset must be later than sunrise. Adjust times.'; return; }

      let mapping = presetMappings[regionSel.value] || presetMappings.default;
      if (regionSel.value === 'custom') {
        // left simple: you can later add custom parsing UI
        mapping = presetMappings.default;
      }

      const wd = new Date(dateVal + 'T00:00').getDay();
      const rahuSlot = mapping.rahu[wd];
      const yamaSlot = mapping.yama[wd];
      const rSlot = computeSlotTimes(sunriseMin, sunsetMin, rahuSlot);
      const ySlot = computeSlotTimes(sunriseMin, sunsetMin, yamaSlot);

      const baseStart = sunriseMin - 8 * MUHURTA;
      const muList = [];
      for (let i=0;i<40;i++){ const s = baseStart + i*MUHURTA; muList.push({ idx:i-8, start:s, end:s+MUHURTA }); }
      const durBlocks = muList.filter(w => mapping.durIndices.includes(w.idx)).map(w => ({start:w.start,end:w.end}));
      const varBefore = { start: sunriseMin - HALF_MUHURTA, end: sunriseMin };
      const varAfter = { start: sunsetMin, end: sunsetMin + HALF_MUHURTA };

      const weekdayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];

      // timezone offset and IANA name
      const tzName = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Local';
      const offsetMin = -new Date().getTimezoneOffset(); // minutes east of UTC
      const utcLabel = (function(){ const sign = offsetMin >= 0 ? '+' : '-'; const abs = Math.abs(offsetMin); const hh = String(Math.floor(abs/60)).padStart(2,'0'); const mm = String(abs%60).padStart(2,'0'); return `UTC${sign}${hh}:${mm}`; })();

      const wrap = document.createElement('div');
      wrap.innerHTML = `
        <h4 style="margin:8px 0">Results — ${dateVal} — ${weekdayNames[wd]} <span class="tz-label">(${utcLabel} — ${tzName})</span></h4>
        <table style="width:100%;border-collapse:collapse">
          <tr><td style="width:170px"><strong>Sunrise</strong></td><td>${sunriseVal}</td></tr>
          <tr><td><strong>Sunset</strong></td><td>${sunsetVal}</td></tr>
          <tr><td><strong>Daytime (mins)</strong></td><td>${sunsetMin - sunriseMin} minutes</td></tr>
          <tr><td><strong>1/8th slot</strong></td><td>${((sunsetMin - sunriseMin)/8).toFixed(1)} minutes</td></tr>
        </table>
        <hr style="margin:10px 0">
        <h5>Rāhu Kāla</h5><p class="small">Slot #${rahuSlot}: <strong>${minutesToHHMM(rSlot.start)} — ${minutesToHHMM(rSlot.end)}</strong></p>
        <h5>Yāma Gaṇḍā</h5><p class="small">Slot #${yamaSlot}: <strong>${minutesToHHMM(ySlot.start)} — ${minutesToHHMM(ySlot.end)}</strong></p>
        <h5>Durmuhurta (example 48-min windows)</h5>
        <ul class="small">${durBlocks.map(b=>`<li>${minutesToHHMM(b.start)} — ${minutesToHHMM(b.end)}</li>`).join('')}</ul>
        <h5>Varjyam (examples)</h5>
        <ul class="small"><li>Before sunrise: ${minutesToHHMM(varBefore.start)} — ${minutesToHHMM(varBefore.end)}</li><li>After sunset: ${minutesToHHMM(varAfter.start)} — ${minutesToHHMM(varAfter.end)}</li></ul>
        <p class="small muted">Preset: <strong>${regionSel.value}</strong></p>
        <p style="margin-top:8px"><button id="copyResults" class="activity-btn">Copy results</button> <a class="activity-btn" href="services-page.html" style="background:var(--accent);color:#fff;border:none">Book Muhurtha</a></p>
      `;
      resultsEl.appendChild(wrap);
      document.getElementById('copyResults')?.addEventListener('click', ()=>{
        const txt = `Date: ${dateVal}\nTimezone: ${utcLabel} — ${tzName}\nSunrise: ${sunriseVal}\nSunset: ${sunsetVal}\nRahu Kala (slot ${rahuSlot}): ${minutesToHHMM(rSlot.start)} - ${minutesToHHMM(rSlot.end)}\nYama Ganda (slot ${yamaSlot}): ${minutesToHHMM(ySlot.start)} - ${minutesToHHMM(ySlot.end)}\nDurmuhurta examples: ${durBlocks.map(b=>minutesToHHMM(b.start)+'-'+minutesToHHMM(b.end)).join(', ')}\nVarjyam examples: ${minutesToHHMM(varBefore.start)}-${minutesToHHMM(varBefore.end)}, ${minutesToHHMM(varAfter.start)}-${minutesToHHMM(varAfter.end)}\n(Preset: ${regionSel.value})`;
        navigator.clipboard?.writeText(txt).then(()=> alert('Copied results')).catch(()=> prompt('Copy results', txt));
      });
    }

    // hooks
    const geoBtnEl = document.getElementById('geoBtn');
    const calcBtnEl = document.getElementById('calcBtn');
    if (calcBtnEl) calcBtnEl.addEventListener('click', computeAndRender);
    if (geoBtnEl) geoBtnEl.addEventListener('click', ()=> tryAutoDetectAndFill(true));

    // start
    window.addEventListener('load', ()=> tryAutoDetectAndFill(true));

  })();
  </script>
</body>
</html>
